pipeline:
  subsample:
    seed: 12345
    satellite:         
      _default: 30    # default for any unspecified instrument
      # atms: 6         # keep every N-th sample (stride); stride or keep ~1/N of samples uniformly (random)
      avhrr: 100
      # amsua: 3   
      # ascat: 2
    conventional:
      _default: 1
      surface_obs: 1
      radiosonde: 1
      aircraft: 1
    # snow_cover: 1        # keep all (stride 1)
    mode:
      satellite:
        _default: random  # "stride" | "random" | "none"
        atms: random
        amsua: random
        avhrr: random
        ascat: random   # ASCAT sampling mode
      conventional:
        _default: random
    #   snow_cover: none    # ignore subsampling for snow_cover


instrument_weights:
  atms: 1.0
  amsua: 1.0
  avhrr: 1.0
  surface_obs: 1.0
  radiosonde: 1.0
  ascat: 1.0
  aircraft: 1.0
  # snow_cover: 1.0
  ssmis: 1.0
  seviri: 1.0


channel_weights:
  atms: [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0] 
  amsua: [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
  avhrr: [1.0, 1.0, 1.0]
  surface_obs: [0.5, 1.0, 1.0, 1.0, 1.0]   # one per predicted feature (5): pressure, temp, dewpoint, wind_u, wind_v
  radiosonde: [1.0, 1.0, 1.0, 1.0]
  aircraft: [1.0, 1.0, 1.0, 1.0]
  ascat: [1.0, 1.0, 1.0]
  ssmis: [
    1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 
    1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 
    1.0, 1.0, 1.0, 1.0
    ]
  seviri: [
    1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 
    1.0, 1.0, 1.0, 1.0, 1.0, 1.0
    ]


observation_config:
  satellite:
    atms:
      sat_ids: [224, 225]
      scan_angle_channels: 1  # Number of scan angle dimensions
      features: [bt_channel_1, bt_channel_2, bt_channel_3, bt_channel_4, bt_channel_5,
                 bt_channel_6, bt_channel_7, bt_channel_8, bt_channel_9, bt_channel_10,
                 bt_channel_11, bt_channel_12, bt_channel_13, bt_channel_14, bt_channel_15,
                 bt_channel_16, bt_channel_17, bt_channel_18, bt_channel_19, bt_channel_20,
                 bt_channel_21, bt_channel_22]
      metadata: [sensorZenithAngle, solarZenithAngle, solarAzimuthAngle]
      input_dim: 32
      target_dim: 22
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2

    amsua:
      sat_ids: [3, 5, 206, 209, 223]
      scan_angle_channels: 1  # Number of scan angle dimensions
      features: [bt_channel_1, bt_channel_2, bt_channel_3, bt_channel_4, bt_channel_5,
                bt_channel_6, bt_channel_7, bt_channel_8, bt_channel_9, bt_channel_10,
                bt_channel_11, bt_channel_12, bt_channel_13, bt_channel_14, bt_channel_15]
      metadata: [sensorZenithAngle, solarZenithAngle, solarAzimuthAngle]
      input_dim: 25
      target_dim: 15
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2

    ssmis:
      sat_ids: [285,]
      scan_angle_channels: 2  # Number of scan angle dimensions
      features: [bt_ch_1, bt_ch_2, bt_ch_3, bt_ch_4, bt_ch_5,
                 bt_ch_6, bt_ch_7, bt_ch_8, bt_ch_9, bt_ch_10,
                 bt_ch_11, bt_ch_12, bt_ch_13, bt_ch_14, bt_ch_15,
                 bt_ch_16, bt_ch_17, bt_ch_18, bt_ch_19, bt_ch_20,
                 bt_ch_21, bt_ch_22, bt_ch_23, bt_ch_24]
      metadata: [sensorScanPosition, satelliteAscendingFlag]
      input_dim: 33
      target_dim: 24
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2

    seviri:
      sat_ids: [56, 57]  # Meteosat-11
      scan_angle_channels: 1  # Number of scan angle dimensions
      features: [bt_all_ch_4, bt_all_ch_5, bt_all_ch_6, bt_all_ch_7, 
                 bt_all_ch_8, bt_all_ch_9, bt_all_ch_10, bt_all_ch_11,
                 bt_clear_ch_4, bt_clear_ch_5, bt_clear_ch_6, bt_clear_ch_7,
                 bt_clear_ch_8, bt_clear_ch_9, bt_clear_ch_10, bt_clear_ch_11
                ]
      metadata: [satelliteZenithAngle, solarZenithAngle]
      input_dim: 25
      target_dim: 16
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2

    avhrr:
      sat_ids: [3, 5, 209, 223]
      scan_angle_channels: 1  # Number of scan angle dimensions
      features: [brightnessTemperature_ch_50, brightnessTemperature_ch_51, brightnessTemperature_ch_52]
      metadata: [satelliteZenithAngle, solarZenithAngle]
      input_dim: 12
      target_dim: 3
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2

    ascat:
      sat_ids: [3]  # MetOp satellite IDs
      scan_angle_channels: 3  # ASCAT has 3 beams, each with its own scan angle
      features: [backscatter_ch_1, backscatter_ch_2, backscatter_ch_3]  # fore, mid, aft beams
      metadata: [radarIncidenceAngle_ch_1, radarIncidenceAngle_ch_2, radarIncidenceAngle_ch_3,
                 antennaBeamAzimuthAngle_ch_1, antennaBeamAzimuthAngle_ch_2, antennaBeamAzimuthAngle_ch_3]  # angles for each channel (beam IDs are implicit in channel order)
      input_dim: 16   # 7 (geo/time) + 6 (metadata) + 3 (features)
      target_dim: 3   # 3 backscatter channels
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2
      qc_strict_flags: true     # ensure missing flags are rejected
      qc_filters:
        # QC filters: Based on empirical data analysis (1M samples)
        # ascatSigma0Usability: 0=usable (96-99% of data), 1=good (1-4%), 2147483647=missing
        # Both 0 and 1 contain valid backscatter data matching feature_stats means
        backscatter_ch_1:
          range: [-55.0, 3.0]  # 2022-2024 dB data: 0.1–99.9% ≈ [-39.8, -2.3]; allow +0.7 dB buffer
          qm_flag_col: ascatSigma0Usability_ch_1
          keep: [0]
        backscatter_ch_2:
          range: [-55.0, 5.0]  # 2022-2024 dB data: 0.1–99.9% ≈ [-35.6, -0.6]; retain wet-snow spikes
          qm_flag_col: ascatSigma0Usability_ch_2
          keep: [0]
        backscatter_ch_3:
          range: [-55.0, 3.2]  # 2022-2024 dB data: 0.1–99.9% ≈ [-39.6, -2.4]
          qm_flag_col: ascatSigma0Usability_ch_3
          keep: [0]

  conventional:
    surface_obs:
      source: zarr
      zarr_name: raw_surface_obs
      # height maps to height_pb_event_1 in the Zarr file
      # Using airPressure_pb_event_1 (station pressure) instead of pressureMeanSeaLevel_pb
      # because pressureMeanSeaLevel_pb appears to be all missing values (3.4e38)
      features: [airPressure_pb_event_1, airTemperature, dewPointTemperature, wind_u, wind_v]
      metadata: [height_pb_event_1]
      input_dim: 13                      # 7 (geo/time enc) + 1 meta + 5 feats
      target_dim: 5
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2
      qc_filters:
        airPressure_pb_event_1:
          range: [300, 1100]            # hPa; physically reasonable surface pressure range
          qm_flag_col: airPressureQuality_event_1
          keep: [1,2]
        airTemperature:
          range: [-90, 60]              # Celsius; physically reasonable surface temperature range
          qm_flag_col: airTemperatureQuality_event_1
          keep: [1,2,4,9]
        dewPointTemperature:
          range: [-100, 50]             # Celsius; physically reasonable (Td ≤ T, can be very dry)
          qm_flag_col: dewPointTemperatureQuality_event_1
          keep: [1,2,4,9]
        windSpeed:
          range: [0, 100]               # m/s; physically reasonable (hurricanes ~90 m/s, allow margin)
        windDirection:
          range: [0, 360]               # degrees (NOTE: zarr metadata incorrectly says "radians")

      qc_relations:                   # cross-variable checks
        dewpoint_le_temp: true        # Td ≤ T (+0.5 °C margin)
        max_temp_dewpoint_spread: 60  # °C; invalid if T - Td > 60
        rh_from_td_consistency_pct: 25  # %pts; invalidate RH if |RH - RH*| > 25
        pressure_vs_height:
          enable: true
          tolerance_hpa: 100          # |p - p_exp(height)| ≤ 100 hPa
          scale_height_m: 8000

    radiosonde:
      source: zarr
      zarr_name: raw_radiosonde
      # NOTE: airPressure removed from features - now used as vertical coordinate in metadata
      # Predicting: Temperature, Dewpoint, Wind components (4 variables)
      features: [airTemperature, dewPointTemperature, wind_u, wind_v]
      metadata: [log_pressure_height]  # Derived from airPressure: z = -8000 * ln(P/1013.25)
      input_dim: 12                    # 7 (geo/time enc) + 1 meta + 4 feats [+8 pressure embedding added by model]
      target_dim: 4                    # Only predict T, Td, u, v (not pressure)
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2
      level_selection:
        filter_col: airPressure
        matching_mode: all  # Use ALL pressure levels (no filtering)
      qc_filters:
        # Keep airPressure QC to filter bad pressure values (needed for log_pressure_height)
        airPressure:
          range: [1, 1100]              # hPa; physically reasonable (surface to high altitude)
          qm_flag_col: airPressureQuality
          keep: [1, 2]
        airTemperature:
          range: [-90, 50]              # Celsius; physically reasonable atmospheric range
          qm_flag_col: airTemperatureQuality
          reject: [13, 14, 15]          # Reject bad flags
        dewPointTemperature:
          range: [-120, 40]             # Celsius; physically reasonable (very dry stratosphere to humid surface)
          qm_flag_col: dewPointTemperatureQuality
          reject: [13, 14, 15]          # Reject bad flags
        windSpeed:
          range: [0, 150]               # m/s; physically reasonable (jet stream can exceed 100 m/s)
          qm_flag_col: windQuality
          keep: [2]                     # Keep only good flag 2
        windDirection:
          range: [0, 6.28]              # radians; full circle 0-2π
          qm_flag_col: windQuality
          keep: [2]                     # Keep only good flag 2

    aircraft:
      source: zarr
      zarr_name: aircraft
      # NOTE: Similar to radiosonde - airPressure used as vertical coordinate
      # Aircraft measures: Temperature, Wind components, and Humidity
      # UNITS: airTemperature=°C, airPressure=hPa, specificHumidity=kg/kg, windU/windV=m/s
      features: [airTemperature, specificHumidity, windU, windV]
      metadata: [log_pressure_height]  # Derived from airPressure: z = -8000 * ln(P/1013.25)
      input_dim: 12                    # 7 (geo/time enc) + 1 meta + 4 feats [+8 pressure embedding added by model]
      target_dim: 4                    # Predict T, q, u, v
      encoder_hidden_layers: 2
      decoder_hidden_layers: 2
      qc_filters:
        # QC filters based on physical reasonableness
        airPressure:
          range: [100, 1100]             # hPa; physically reasonable for aircraft altitude range
          qm_flag_col: airPressureQuality
          keep: [0, 1, 2]
        airTemperature:
          range: [-90, 50]               # Celsius; physically reasonable for atmospheric temperature
          qm_flag_col: airTemperatureQuality
          keep: [0, 1, 2]
        specificHumidity:
          range: [0.0, 0.040]            # kg/kg; physically reasonable (max ~35 g/kg at 40°C)
          qm_flag_col: specificHumidityQuality
          reject: [3, 9, 13, 14, 15]     # Reject doubtful/bad flags
        windU:
          range: [-100, 100]             # m/s; physically reasonable (jet stream winds)
          qm_flag_col: windQuality
          keep: [0, 1, 2]
        windV:
          range: [-100, 100]             # m/s; physically reasonable (jet stream winds)
          qm_flag_col: windQuality
          keep: [0, 1, 2]

feature_stats:  # Statistics for the features used in the model (with FULL QC filtering applied)
  surface_obs:
    airPressure_pb_event_1: [985.30, 49.97]       # hPa (station pressure); 2020-2024: 602M valid samples (95.8% pass QC)
    airTemperature: [13.99, 12.14]                # Celsius; 2020-2024: 545M valid samples (87.2% pass QC)
    dewPointTemperature: [7.94, 11.47]            # Celsius; 2020-2024: 485M valid samples (77.7% pass QC)
    wind_u: [0.03, 3.30]                          # m/s (u-component, computed from windSpeed/windDirection)
    wind_v: [-0.03, 3.37]                         # m/s (v-component, computed from windSpeed/windDirection)

  radiosonde:  
    airPressure: [319.23, 296.08]            # hPa (not in features, used as metadata for log_pressure_height)
    airTemperature: [-32.49, 28.82]          # Celsius (as stored in zarr); 2020-2024: ~54% pass QC
    dewPointTemperature: [-47.40, 34.48]     # Celsius (as stored in zarr); 2020-2024: ~52% pass QC
    wind_u: [4.95, 13.71]                    # m/s (computed from windSpeed/windDirection); 2020-2024: ~60% pass QC
    wind_v: [-0.31, 8.13]                    # m/s (computed from windSpeed/windDirection); 2020-2024: ~60% pass QC

  aircraft:
    airPressure: [505.53, 274.24]            # hPa (not in features, used as metadata for log_pressure_height)
    airTemperature: [-18.56, 27.68]          # Celsius; 2020-2024: ~91% pass QC (flags 0,1,2)
    specificHumidity: [0.0038, 0.0043]       # kg/kg; 2020-2024: ~6% pass QC (sparse data!)
    windU: [11.28, 15.43]                    # m/s; 2020-2024: ~92% pass QC (flags 0,1,2)
    windV: [0.27, 11.46]                     # m/s; 2020-2024: ~92% pass QC (flags 0,1,2)

  atms:
    bt_channel_1: [211.00, 40.60]
    bt_channel_2: [201.65, 42.08]
    bt_channel_3: [239.09, 22.24]
    bt_channel_4: [248.58, 17.55]
    bt_channel_5: [252.58, 14.32]
    bt_channel_6: [245.75, 11.47]
    bt_channel_7: [231.98, 8.21]
    bt_channel_8: [222.52, 6.76]
    bt_channel_9: [216.10, 7.30]
    bt_channel_10: [211.99, 9.49]
    bt_channel_11: [215.01, 9.37]
    bt_channel_12: [221.00, 10.17]
    bt_channel_13: [229.26, 11.30]
    bt_channel_14: [240.06, 11.97]
    bt_channel_15: [250.28, 11.52]
    bt_channel_16: [237.76, 28.61]
    bt_channel_17: [258.29, 29.35]
    bt_channel_18: [260.31, 22.15]
    bt_channel_19: [258.26, 18.46]
    bt_channel_20: [255.12, 15.34]
    bt_channel_21: [250.24, 12.39]
    bt_channel_22: [245.38, 10.41]
  amsua:
    bt_channel_1: [209.92, 40.44]
    bt_channel_2: [201.16, 42.14]
    bt_channel_3: [239.63, 20.68]
    bt_channel_4: [252.44, 14.20]
    bt_channel_5: [245.45, 11.31]
    bt_channel_6: [231.10, 7.86]
    bt_channel_7: [222.16, 6.51]
    bt_channel_8: [216.24, 7.12]
    bt_channel_9: [211.48, 9.39]
    bt_channel_10: [214.51, 9.34]
    bt_channel_11: [220.23, 10.18]
    bt_channel_12: [228.57, 11.32]
    bt_channel_13: [239.08, 11.94]
    bt_channel_14: [249.39, 11.47]
    bt_channel_15: [237.78, 28.23]
  avhrr:
    brightnessTemperature_ch_50: [284.58, 17.52]
    brightnessTemperature_ch_51: [283.07, 15.83]
    brightnessTemperature_ch_52: [281.21, 15.2]
  ascat:
    backscatter_ch_1: [-17.84, 5.77]   # 2022-2024 dB mean/std (filtered to [-80, 40] dB)
    backscatter_ch_2: [-14.84, 5.12]
    backscatter_ch_3: [-17.81, 5.73]
  ssmis:
    bt_ch_1 : [238.43,  20.42]
    bt_ch_10: [252.93,  11.01]
    bt_ch_11: [241.98,   9.31]
    bt_ch_12: [182.48,  53.52]
    bt_ch_13: [224.26,  34.52]
    bt_ch_14: [237.05,  29.52]
    bt_ch_15: [194.48,  44.93]
    bt_ch_16: [231.97,  26.43]
    bt_ch_17: [250.07,  26.02]
    bt_ch_18: [231.07,  32.5 ]
    bt_ch_19: [229.95,  7.91]
    bt_ch_2 : [250.4 ,  16.73]
    bt_ch_20: [212.22,  9.38]
    bt_ch_21: [247.08,  6.36]
    bt_ch_22: [247.2 ,  9.42]
    bt_ch_23: [237.59,  8.08]
    bt_ch_24: [225.99,  5.44]
    bt_ch_3 : [241.66,  13.37]
    bt_ch_4 : [228.59,   5.36]
    bt_ch_5 : [216.18,   8.4 ]
    bt_ch_6 : [213.07,   8.51]
    bt_ch_7 : [217.33,   6.51]
    bt_ch_8 : [250.04,   35.18]
    bt_ch_9 : [257.22,  22.09]
  seviri:
    bt_all_ch_10  : [99.96, 277.3 ]
    bt_all_ch_11  : [99.96, 258.43]
    bt_all_ch_4   : [99.95, 282.76]
    bt_all_ch_5   : [99.96, 237.52]
    bt_all_ch_6   : [99.96, 254.45]
    bt_all_ch_7   : [99.96, 276.94]
    bt_all_ch_8   : [99.96, 257.69]
    bt_all_ch_9   : [99.96, 278.99]
    bt_clear_ch_10: [73.44, 288.78]
    bt_clear_ch_11: [73.44, 265.8 ]
    bt_clear_ch_4 : [73.44, 290.5 ]
    bt_clear_ch_5 : [73.44, 240.42]
    bt_clear_ch_6 : [73.44, 259.62]
    bt_clear_ch_7 : [73.44, 287.69]
    bt_clear_ch_8 : [73.44, 264.72]
    bt_clear_ch_9 : [73.44, 290.49]